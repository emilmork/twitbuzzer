(function(a){var b=a({});a.subscribe=function(){b.on.apply(b,arguments)},a.unsubscribe=function(){b.off.apply(b,arguments)},a.publish=function(){b.trigger.apply(b,arguments)}})(jQuery);var App=function(a,b,c,d,e,f){"use strict";var g=function(){return this.init(arguments[0]),this};return g.prototype={isSearch:!1,keyword:"",prevLen:0,timeoutSearch:f,isLoading:!1,scrollingMargin:10,isAtBottom:!1,init:function(d){var f=this;this.$searchBox=a(d)||a("#twitbuzzer-q"),f.socket=e.connect(c.location.hostname),f._infiniteScroll(),f._bindEvents(),f._ajaxSettings(),f.viewModel.sortedRepos=b.computed({read:function(){return this.repos.slice().sort(this.sortFunc)},owner:f.viewModel}),b.applyBindings(f.viewModel),f.viewModel.app=f,f.get()},_ajaxSettings:function(){var b=this;a.ajaxSetup({type:"GET",dataType:"json",contentType:"application/json"}),a(".loading-indicator").hide().ajaxStart(function(){var c=a(this);b.isLoading=!0,setTimeout(function(){c.fadeIn()},0)}).ajaxComplete(function(){var c=a(this);setTimeout(function(){c.fadeOut()},0),b.isLoading=!1})},_bindEvents:function(){var b=this;b.socket.on("tweeted_repo",function(c){b.viewModel.updateRepo(c,function(c,d){c?a.publish("repos.updatedRepo",d):(b.isAtBottom&&b.matchesInSearch(d)&&b.viewModel.addItem(d),a.publish("repos.newRepo",d))})}),a.subscribe("repos.loadMore",function(){b.get()}),b.$searchBox.on("keyup",function(c){return c.preventDefault(),b.search(a(this)),!1}),b.$searchBox.parents("form").on("submit",function(a){return a.preventDefault(),!1})},matchesInSearch:function(a){if(!this.isSearch)return!0;var b=new RegExp("^"+this.keyword,"i");return b.test(a.info.user)||b.test(a.info.repo)},search:function(a){this.timeoutSearch&&clearTimeout(this.timeoutSearch);var b=a.val(),c=b.length,d=this;if(c<3&&this.prevLen>c&&this.prevLen>2){this.keyword="",this.isSearch=!1,this.reset(),this.get(),d.prevLen=c;return}if(c<3){d.prevLen=c;return}if(this.prevLen===c)return;this.keyword=b,this.isSearch=!0,this.timeoutSearch=setTimeout(function(){d.reset(),d.get(),d.prevLen=c},500)},_infiniteScroll:function(){var b=this;a(c).scroll(function(){a(c).scrollTop()+b.scrollingMargin>a(d).height()-a(c).height()&&!b.isLoading&&!b.isAtBottom&&a.publish("repos.loadMore")})},reset:function(){var a=this;a.viewModel.clear(),a.isAtBottom=!1,a.prevLen=0},get:function(){this.isSearch?this.viewModel.search(this.keyword):this.viewModel.append()},viewModel:{repos:b.mapping.fromJS([],{repos:{key:function(a){return a._id}}}),sortFunc:function(a,b){return b.tweet_count()-a.tweet_count()},currentPage:0,loadNumber:10,cache:[],app:null,clear:function(){this.repos.removeAll(),this.cache=[],this.currentPage=0},addItem:function(c){var d=this;d.cache=a.merge(b.utils.unwrapObservable(d.repos),[c]),b.mapping.fromJS({repos:d.cache},d.mapping,d),a.publish("repos.rendered")},append:function(){var b="/api/list/"+this.currentPage+"/"+this.loadNumber;this.currentPage+=1,this._fetch(b).done(function(){a.publish("repos.rendered")})},search:function(b){var c="/api/search/"+b+"/"+this.currentPage+"/"+this.loadNumber;this.currentPage+=1,this._fetch(c).done(function(){a.publish("repos.rendered")})},updateRepo:function(a,c){var d=this.repos(),e=d.length,f,g;for(f=0;f<e;f+=1){g=d[f];if(g._id()===a._id){g.tweet_count(a.tweet_count),b.mapping.fromJS(a.repo_info,{},g.repo_info),g.dates(a.dates),this.repos.valueHasMutated(),c.apply(g,[!0,b.utils.unwrapObservable(g)]);return}}c.apply(a,[!1,a])},_fetch:function(c){var d=this;return a.ajax({url:c}).done(function(c,e,f){if(f.status===204){app.isAtBottom=!0;return}d.cache=a.merge(b.utils.unwrapObservable(d.repos),c),b.mapping.fromJS({repos:d.cache},d.mapping,d)})}}},g}(jQuery,ko,window,document,io),app=new App($("#q"));$.subscribe("repos.rendered",function(){$(".repo-graph").repoTweetGraph()}),$.subscribe("repos.updatedRepo",function(a,b){var c=$("#listing").find('[data-repo-id="'+b._id()+'"]');c.addClass("repo-highlight"),setTimeout(function(){c.removeClass("repo-highlight")},3e3),c.find(".repo-graph").repoTweetGraph("refresh")}),$.subscribe("repos.newRepo",function(a){}),function(a,b){a.fn.noisy=function(c){return typeof c=="undefined"&&(c=.1),this.each(function(){var d=a(this),e=b.createElement("canvas");e.width=100,e.height=100;var f=e.getContext("2d"),g,h,i=75;for(g=0;g<e.width;g+=1)for(h=0;h<e.height;h+=1){var j=Math.floor(Math.random()*i),k=Math.floor(Math.random()*i),l=Math.floor(Math.random()*i);f.fillStyle="rgba("+j+","+k+","+l+","+c+")",f.fillRect(g,h,1,1)}d.css({"background-image":"url("+e.toDataURL("image/png")+")",width:"100%",height:"100%"})})}}(jQuery,document),$(function(){$("body").noisy(.1)});