<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Bootstrap, from Twitter</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/bootstrap-alerts.js"></script>
    <script src="/js/bootstrap-twipsy.js"></script>

    <script src="js/icanhaz.js"></script>
    <script>
      var socket = io.connect(window.location.hostname);
      socket.on('new_tweet', function (data) {
        console.log(data);
        var id = data.data.id;

        var $item = $('[data-repo-id="'+id+'"]');


        if($item.length > 0) {
          var $plusOne = $("<span class='label success' />").html("+1");
          var $counter = $item.find(".count span");
          console.log("Counter obj:", $counter);
          var $counter_wrap = $item.find(".count");
          console.log("Counter wrapper obj:", $counter_wrap);

          $plusOne.appendTo($counter_wrap).hide();

          $plusOne.fadeIn("fast", function () {
            var $this = $(this);
            setTimeout(function () {
              $this.fadeOut("slow", function () {
                $this.remove();
              });
            }, 3000);
          });

          var counter = parseInt($counter.html()) + 1;
          console.log("Int value:", counter);
          $counter.html(counter);
          $item.attr("data-count", counter);

          console.log("Result:", $counter);


          // Move item up. 

          var $topItem = $("[data-count='"+(counter-1)+"']").first();

          console.log("Top item", $topItem);

          // Not already at top. 
          if ($topItem.length > 0 && $topItem.attr("data-repo-id") != id) {
            $item.fadeOut("slow", function () {
              var $oldItem = $(this).detach();
              console.log("Old item", $oldItem);

              $topItem.before($oldItem);
              $oldItem.fadeIn("slow");
            })
          }

          var obj = {
            notice: "Repo " + data.data.owner.login + "/" + data.data.name + " got another tweet! Is now at " + counter + " tweets."
          }

          var $alert = ich.alert(obj).prependTo("#content-box").hide()

          $alert.fadeIn("fast", function () {
            var $this = $(this);
            setTimeout(function () {
              $this.fadeOut("slow", function () {
                $this.remove();
              });
            }, 5000);
          });



        } else {
          var obj = {
            notice: "Newly tweeted repo: " + data.data.owner.login + "/" + data.data.name + "!"
          }

          var $alert = ich.alert(obj).prependTo("#content-box").hide()

          $alert.fadeIn("fast", function () {
            var $this = $(this);
            setTimeout(function () {
              $this.fadeOut("slow", function () {
                $this.remove();
              });
            }, 5000);
          });
        }


        // $("<p />").html("New " + data.type + " item").appendTo("body");
      });


      var page  = 1,
          history = 1000,
          limit = 10,
          scrollingMargin = 150,
          isLoading = false;

      $(".alert-message").alert();

      $(function () {
        loadData("/github");

        

        var $loadMore = $("<p />").attr("id", "load-more-content");
        $("#content-box ul").after($loadMore);
        $loadMore.hide();
      });

      infiniteScroll(scrollingMargin, function () {
        loadData("/github/" + history + "/" + limit + "/" + page)
      });

      function loadData (url) {
        isLoading = true;
        $("#load-more-content").fadeIn();
        $.getJSON(url, function (data) {
          $(data).each(function () {

            this.value.data.id = this._id;
            this.value.data.count = this.value.count;

            if(/\?/.test(this.value.data.owner.avatar_url)) {
              this.value.data.owner.avatar_url += "&s=30";
            } else {
              this.value.data.owner.avatar_url += "?s=30";
            }

            this.value.data.owner.url = "http://github.com/" + this.value.data.owner.login;

            var item = ich.item(this.value.data);
            $("#content-box ul").append(item);
          });
          isLoading = false;
          $("#load-more-content").fadeOut();
        });
      }

      function infiniteScroll (scrollingMargin, callback) {
        $(window).scroll(function() {
          if($(window).scrollTop() + scrollingMargin > $(document).height() - $(window).height() && !isLoading) {
            page += 1;
            callback();
          }
        });
      }


    </script>



    <script type="text/javascript">

    // Big up to Jeffrey Way for this noise generator (http://net.tutsplus.com/tutorials/javascript-ajax/how-to-generate-noise-with-canvas/)

    function generateNoise(opacity) {
      if (!!!document.createElement('canvas').getContext) {  
        return false;  
      }
      
      var canvas = document.createElement("canvas"),  
      ctx = canvas.getContext('2d'),  
      x, y,  
      number,  
      opacity = opacity || .2;  
      
      canvas.width = 250;
      canvas.height = 250;
      
      for(x = 0; x < canvas.width; x++) {  
        for(y = 0; y < canvas.height; y++) {  
           number = Math.floor(Math.random() * 40); 
           ctx.fillStyle = "rgba(" + number + "," + number + "," + number + "," + opacity + ")";  
           ctx.fillRect(x, y, 1, 1);
        }  
      }  
      
      if(jQuery.browser.mozilla) {
        document.body.style.backgroundImage = "-moz-radial-gradient(center center, rgba(0, 0, 0, 0), rgba(0, 0, 0, .4)), url(" + canvas.toDataURL("image/png") + ")";
        document.getElementById("header").style.backgroundImage = "-moz-radial-gradient(center center, rgba(0, 0, 0, 0), rgba(0, 0, 0, .4)), url(" + canvas.toDataURL("image/png") + ")";

      } else {
        document.body.style.backgroundImage = "-webkit-gradient(radial, center 250, 0, center 250, 1000, from(rgba(0, 0, 0, 0)), to(rgba(0, 0, 0, .4))), url(" + canvas.toDataURL("image/png") + ")";
        document.getElementById("header").style.backgroundImage = "-webkit-gradient(radial, center 250, 0, center 250, 1000, from(rgba(0, 0, 0, 0)), to(rgba(0, 0, 0, .4))), url(" + canvas.toDataURL("image/png") + ")";
      }
    }

    $(document).ready(function() {
      generateNoise(.2);
    });


    </script>

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  </head>

  <body>

    <div class="container">

      <div class="content">
        <div class="page-header" id="header">
          <h1 data-tile="twitbuzzer"><a href="#">twitbuzzer</a></h1>
          <p><small>the twitter live tracker for Github repos.</small></p>
        </div>
        <div class="content-wrapper">
          <div class="row">
            <div class="span9" id="content-box">
              <ul class="unstyled">
              </ul>
            </div>
            <div class="span5">
              <h3>Settings</h3>
              <form class="form-stacked">
                <fieldset>
                  <div class="clearfix">
                    <label for="stackedSelect">Time limit</label>
                    <div class="input">
                      <select name="stackedSelect" id="stackedSelect">
                        <option>All time</option>
                        <option>7 days</option>
                        <option>30 days</option>
                        <option>365 days</option>
                      </select>
                    </div>
                  </div><!-- /clearfix -->
                  
                  <div class="clearfix">
                    <label id="optionsRadio">Show type</label>
                    <div class="input">
                      <ul class="inputs-list">
                        <li>
                          <label>
                            <input type="radio" checked name="optionsRadios" value="option1" />
                            <span>Github Repositories</span>
                          </label>
                        </li>
                        <li>
                          <label>
                            <input type="radio" disabled name="optionsRadios" value="option2" />
                            <span>Spotify Songs</span>
                          </label>
                        </li>
                      </ul>
                    </div>
                  </div><!-- /clearfix -->
                </fieldset>
              </form>


              <h3>Thanks to</h3>
              <dl>
                <dn><b>Twitter Bootstrap</b></dn>
                <dd>http://github.com/twitter/bootstrap</dd>
                <dn><b>Node-spotify</b></dn>
                <dd>http://github.com/twitter/node-spotify</dd>
                <dn><b>Socket.IO</b></dn>
                <dd>http://socket.io</dd>
              </dl>

            </div>
          </div>
        </div>
      </div>
      <footer>
        <p>&copy; TwitBuzzer 2011 - About - Legal</p>
      </footer>
    </div> <!-- /container -->

    <script id="item" type="text/html">
      <li data-repo-id="{{id}}" data-count="{{count}}">
        <div class="item">
          <div class="row">
            <div class="span5">
              <h3><a href="{{html_url}}" title="{{name}}">{{name}}</a></h3>
            </div>
            <div class="span3 meta-labels">
              <span class="watchers">
                <span class="label" data-placement="below" rel='twipsy' title='Number of Watchers'>{{watchers}}</span>
              </span>
              <span class="forks">
                <span class="label" data-placement="below" rel='twipsy' title='Number of Forks'>{{forks}}</span>
              </span>
              <span class="count">
                <span class="label notice" data-placement="below" rel='twipsy' title='Number of Tweets'>{{count}}</span>
              </span>
            </div>
          </div>
          <p>{{description}}</p>
        </div>
        <div class="meta-author actions">
          <div class="row">
            <div class="span1">
              <a href="{{#owner}}{{url}}{{/owner}}">
                <img class="thumbnail" src="{{#owner}}{{avatar_url}}{{/owner}}" alt="{{#owner}}{{login}}{{/owner}}">
              </a> 
            </div>
            <div class="span6">
              <a href="{{#owner}}{{url}}{{/owner}}">
                {{#owner}}{{login}}{{/owner}}
              </a>
            </div>
          </div>
        </div>
      </li>
    </script>

    <script id="alert" type="text/html">
      <div class="alert-message warning fade in" data-alert="alert">
        <a class="close" href="#">×</a>
        <p>{{notice}}</p>
      </div>
  </script>
  </body>
</html>